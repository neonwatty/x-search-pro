#!/usr/bin/env sh

set -e

echo "ğŸš¨ Running mandatory pre-push validation..."
echo "âš ï¸  This will take 2-3 minutes to ensure code quality before pushing to remote"
echo ""

echo "ğŸ“ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed! Please fix linting errors before pushing."
  exit 1
fi
echo "âœ… Linting passed"
echo ""

echo "ğŸ” Running TypeScript type check..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed! Please fix type errors before pushing."
  exit 1
fi
echo "âœ… Type check passed"
echo ""

echo "ğŸ§ª Running unit tests (97 tests)..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed! Please fix failing tests before pushing."
  exit 1
fi
echo "âœ… Unit tests passed"
echo ""

echo "ğŸ­ Running E2E tests (headless mode)..."
echo "âš ï¸  This ensures extension works on real X.com pages"
echo "ğŸ“ Tests require Chrome browser and internet connection"
echo ""

# Check if authentication is needed
if [ ! -f "tests/.auth/user.json" ]; then
  echo "ğŸ” No authentication found, running X.com login setup..."
  echo "   (This uses credentials from .env file)"
  npx playwright test tests/setup/auth.setup.ts
  if [ $? -ne 0 ]; then
    echo "âŒ Authentication failed! Please check your .env credentials or run manually:"
    echo "   npx playwright test tests/setup/auth.setup.ts"
    exit 1
  fi
  echo "âœ… Authentication successful"
  echo ""
fi

npm run test:e2e
if [ $? -ne 0 ]; then
  echo "âŒ E2E tests failed! Please fix failing tests before pushing."
  exit 1
fi
echo "âœ… E2E tests passed"
echo ""

echo "ğŸ‰ All validation checks passed! Git will now proceed with push..."